{"version":3,"file":"xml-stream.js","names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","EQUALS_QUOTE","QUOTE","SPACE","pushAttribute","xml","name","value","push","xmlEncode","toString","pushAttributes","attributes","each","undefined","XmlStream","_classCallCheck","_xml","_stack","_rollbacks","_createClass","key","get","length","openXml","docAttributes","openNode","parent","tos","open","leaf","addAttribute","Error","addAttributes","attrs","writeText","text","writeXml","closeNode","node","pop","leafNode","closeAll","addRollback","stack","cursor","commit","rollback","r","splice","join","StdDocAttributes","version","encoding","standalone","module","exports"],"sources":["../../../lib/utils/xml-stream.js"],"sourcesContent":["const _ = require('./under-dash');\r\n\r\nconst utils = require('./utils');\r\n\r\n// constants\r\nconst OPEN_ANGLE = '<';\r\nconst CLOSE_ANGLE = '>';\r\nconst OPEN_ANGLE_SLASH = '</';\r\nconst CLOSE_SLASH_ANGLE = '/>';\r\nconst EQUALS_QUOTE = '=\"';\r\nconst QUOTE = '\"';\r\nconst SPACE = ' ';\r\n\r\nfunction pushAttribute(xml, name, value) {\r\n  xml.push(SPACE);\r\n  xml.push(name);\r\n  xml.push(EQUALS_QUOTE);\r\n  xml.push(utils.xmlEncode(value.toString()));\r\n  xml.push(QUOTE);\r\n}\r\nfunction pushAttributes(xml, attributes) {\r\n  if (attributes) {\r\n    _.each(attributes, (value, name) => {\r\n      if (value !== undefined) {\r\n        pushAttribute(xml, name, value);\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nclass XmlStream {\r\n  constructor() {\r\n    this._xml = [];\r\n    this._stack = [];\r\n    this._rollbacks = [];\r\n  }\r\n\r\n  get tos() {\r\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\r\n  }\r\n\r\n  get cursor() {\r\n    // handy way to track whether anything has been added\r\n    return this._xml.length;\r\n  }\r\n\r\n  openXml(docAttributes) {\r\n    const xml = this._xml;\r\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\r\n    xml.push('<?xml');\r\n    pushAttributes(xml, docAttributes);\r\n    xml.push('?>\\n');\r\n  }\r\n\r\n  openNode(name, attributes) {\r\n    const parent = this.tos;\r\n    const xml = this._xml;\r\n    if (parent && this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n\r\n    this._stack.push(name);\r\n\r\n    // start streaming node\r\n    xml.push(OPEN_ANGLE);\r\n    xml.push(name);\r\n    pushAttributes(xml, attributes);\r\n    this.leaf = true;\r\n    this.open = true;\r\n  }\r\n\r\n  addAttribute(name, value) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    if (value !== undefined) {\r\n      pushAttribute(this._xml, name, value);\r\n    }\r\n  }\r\n\r\n  addAttributes(attrs) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    pushAttributes(this._xml, attrs);\r\n  }\r\n\r\n  writeText(text) {\r\n    const xml = this._xml;\r\n    if (this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    xml.push(utils.xmlEncode(text.toString()));\r\n  }\r\n\r\n  writeXml(xml) {\r\n    if (this.open) {\r\n      this._xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    this._xml.push(xml);\r\n  }\r\n\r\n  closeNode() {\r\n    const node = this._stack.pop();\r\n    const xml = this._xml;\r\n    if (this.leaf) {\r\n      xml.push(CLOSE_SLASH_ANGLE);\r\n    } else {\r\n      xml.push(OPEN_ANGLE_SLASH);\r\n      xml.push(node);\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n    this.open = false;\r\n    this.leaf = false;\r\n  }\r\n\r\n  leafNode(name, attributes, text) {\r\n    this.openNode(name, attributes);\r\n    if (text !== undefined) {\r\n      // zeros need to be written\r\n      this.writeText(text);\r\n    }\r\n    this.closeNode();\r\n  }\r\n\r\n  closeAll() {\r\n    while (this._stack.length) {\r\n      this.closeNode();\r\n    }\r\n  }\r\n\r\n  addRollback() {\r\n    this._rollbacks.push({\r\n      xml: this._xml.length,\r\n      stack: this._stack.length,\r\n      leaf: this.leaf,\r\n      open: this.open,\r\n    });\r\n    return this.cursor;\r\n  }\r\n\r\n  commit() {\r\n    this._rollbacks.pop();\r\n  }\r\n\r\n  rollback() {\r\n    const r = this._rollbacks.pop();\r\n    if (this._xml.length > r.xml) {\r\n      this._xml.splice(r.xml, this._xml.length - r.xml);\r\n    }\r\n    if (this._stack.length > r.stack) {\r\n      this._stack.splice(r.stack, this._stack.length - r.stack);\r\n    }\r\n    this.leaf = r.leaf;\r\n    this.open = r.open;\r\n  }\r\n\r\n  get xml() {\r\n    this.closeAll();\r\n    return this._xml.join('');\r\n  }\r\n}\r\n\r\nXmlStream.StdDocAttributes = {\r\n  version: '1.0',\r\n  encoding: 'UTF-8',\r\n  standalone: 'yes',\r\n};\r\n\r\nmodule.exports = XmlStream;\r\n"],"mappings":"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"}