{"version":3,"file":"shared-strings-xform.js","names":["XmlStream","require","BaseXform","SharedStringXform","SharedStringsXform","_BaseXform","_inherits","_super","_createSuper","model","_this","_classCallCheck","call","values","count","hash","Object","create","rich","_createClass","key","get","_sharedStringXform","length","value","getString","index","add","richText","addRichText","addText","undefined","push","xml","sharedStringXform","toXml","render","xmlStream","_values","openXml","StdDocAttributes","openNode","xmlns","uniqueCount","sx","forEach","sharedString","closeNode","parseOpen","node","parser","name","Error","concat","JSON","stringify","parseText","text","parseClose","module","exports"],"sources":["../../../../../lib/xlsx/xform/strings/shared-strings-xform.js"],"sourcesContent":["const XmlStream = require('../../../utils/xml-stream');\r\nconst BaseXform = require('../base-xform');\r\nconst SharedStringXform = require('./shared-string-xform');\r\n\r\nclass SharedStringsXform extends BaseXform {\r\n  constructor(model) {\r\n    super();\r\n\r\n    this.model = model || {\r\n      values: [],\r\n      count: 0,\r\n    };\r\n    this.hash = Object.create(null);\r\n    this.rich = Object.create(null);\r\n  }\r\n\r\n  get sharedStringXform() {\r\n    return this._sharedStringXform || (this._sharedStringXform = new SharedStringXform());\r\n  }\r\n\r\n  get values() {\r\n    return this.model.values;\r\n  }\r\n\r\n  get uniqueCount() {\r\n    return this.model.values.length;\r\n  }\r\n\r\n  get count() {\r\n    return this.model.count;\r\n  }\r\n\r\n  getString(index) {\r\n    return this.model.values[index];\r\n  }\r\n\r\n  add(value) {\r\n    return value.richText ? this.addRichText(value) : this.addText(value);\r\n  }\r\n\r\n  addText(value) {\r\n    let index = this.hash[value];\r\n    if (index === undefined) {\r\n      index = this.hash[value] = this.model.values.length;\r\n      this.model.values.push(value);\r\n    }\r\n    this.model.count++;\r\n    return index;\r\n  }\r\n\r\n  addRichText(value) {\r\n    // TODO: add WeakMap here\r\n    const xml = this.sharedStringXform.toXml(value);\r\n    let index = this.rich[xml];\r\n    if (index === undefined) {\r\n      index = this.rich[xml] = this.model.values.length;\r\n      this.model.values.push(value);\r\n    }\r\n    this.model.count++;\r\n    return index;\r\n  }\r\n\r\n  // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\r\n  // <sst xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\" count=\"<%=totalRefs%>\" uniqueCount=\"<%=count%>\">\r\n  //   <si><t><%=text%></t></si>\r\n  //   <si><r><rPr></rPr><t></t></r></si>\r\n  // </sst>\r\n\r\n  render(xmlStream, model) {\r\n    model = model || this._values;\r\n    xmlStream.openXml(XmlStream.StdDocAttributes);\r\n\r\n    xmlStream.openNode('sst', {\r\n      xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\r\n      count: model.count,\r\n      uniqueCount: model.values.length,\r\n    });\r\n\r\n    const sx = this.sharedStringXform;\r\n    model.values.forEach(sharedString => {\r\n      sx.render(xmlStream, sharedString);\r\n    });\r\n    xmlStream.closeNode();\r\n  }\r\n\r\n  parseOpen(node) {\r\n    if (this.parser) {\r\n      this.parser.parseOpen(node);\r\n      return true;\r\n    }\r\n    switch (node.name) {\r\n      case 'sst':\r\n        return true;\r\n      case 'si':\r\n        this.parser = this.sharedStringXform;\r\n        this.parser.parseOpen(node);\r\n        return true;\r\n      default:\r\n        throw new Error(`Unexpected xml node in parseOpen: ${JSON.stringify(node)}`);\r\n    }\r\n  }\r\n\r\n  parseText(text) {\r\n    if (this.parser) {\r\n      this.parser.parseText(text);\r\n    }\r\n  }\r\n\r\n  parseClose(name) {\r\n    if (this.parser) {\r\n      if (!this.parser.parseClose(name)) {\r\n        this.model.values.push(this.parser.model);\r\n        this.model.count++;\r\n        this.parser = undefined;\r\n      }\r\n      return true;\r\n    }\r\n    switch (name) {\r\n      case 'sst':\r\n        return false;\r\n      default:\r\n        throw new Error(`Unexpected xml node in parseClose: ${name}`);\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = SharedStringsXform;\r\n"],"mappings":"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"}