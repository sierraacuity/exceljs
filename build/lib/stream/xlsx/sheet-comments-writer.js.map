{"version":3,"file":"sheet-comments-writer.js","names":["XmlStream","require","RelType","colCache","CommentXform","VmlShapeXform","SheetCommentsWriter","worksheet","sheetRelsWriter","options","_classCallCheck","id","count","_worksheet","_workbook","workbook","_sheetRelsWriter","_createClass","key","get","_commentsStream","_openStream","concat","_vmlStream","value","_addRelationships","commentRel","Type","Comments","Target","addRelationship","vmlDrawingRel","VmlDrawing","vmlRelId","_addCommentRefs","commentRefs","push","commentName","vmlDrawing","_writeOpen","commentsStream","write","vmlStream","_writeComment","comment","index","commentXform","commentsXmlStream","render","xml","vmlShapeXform","vmlXmlStream","_writeClose","addComments","comments","_this","length","startedData","forEach","item","refAddress","decodeAddress","ref","commit","end","module","exports"],"sources":["../../../../lib/stream/xlsx/sheet-comments-writer.js"],"sourcesContent":["const XmlStream = require('../../utils/xml-stream');\r\nconst RelType = require('../../xlsx/rel-type');\r\nconst colCache = require('../../utils/col-cache');\r\nconst CommentXform = require('../../xlsx/xform/comment/comment-xform');\r\nconst VmlShapeXform = require('../../xlsx/xform/comment/vml-shape-xform');\r\n\r\nclass SheetCommentsWriter {\r\n  constructor(worksheet, sheetRelsWriter, options) {\r\n    // in a workbook, each sheet will have a number\r\n    this.id = options.id;\r\n    this.count = 0;\r\n    this._worksheet = worksheet;\r\n    this._workbook = options.workbook;\r\n    this._sheetRelsWriter = sheetRelsWriter;\r\n  }\r\n\r\n  get commentsStream() {\r\n    if (!this._commentsStream) {\r\n      // eslint-disable-next-line no-underscore-dangle\r\n      this._commentsStream = this._workbook._openStream(`/xl/comments${this.id}.xml`);\r\n    }\r\n    return this._commentsStream;\r\n  }\r\n\r\n  get vmlStream() {\r\n    if (!this._vmlStream) {\r\n      // eslint-disable-next-line no-underscore-dangle\r\n      this._vmlStream = this._workbook._openStream(`xl/drawings/vmlDrawing${this.id}.vml`);\r\n    }\r\n    return this._vmlStream;\r\n  }\r\n\r\n  _addRelationships() {\r\n    const commentRel = {\r\n      Type: RelType.Comments,\r\n      Target: `../comments${this.id}.xml`,\r\n    };\r\n    this._sheetRelsWriter.addRelationship(commentRel);\r\n\r\n    const vmlDrawingRel = {\r\n      Type: RelType.VmlDrawing,\r\n      Target: `../drawings/vmlDrawing${this.id}.vml`,\r\n    };\r\n    this.vmlRelId = this._sheetRelsWriter.addRelationship(vmlDrawingRel);\r\n  }\r\n\r\n  _addCommentRefs() {\r\n    this._workbook.commentRefs.push({\r\n      commentName: `comments${this.id}`,\r\n      vmlDrawing: `vmlDrawing${this.id}`,\r\n    });\r\n  }\r\n\r\n  _writeOpen() {\r\n    this.commentsStream.write(\r\n      '<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>' +\r\n        '<comments xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\">' +\r\n        '<authors><author>Author</author></authors>' +\r\n        '<commentList>'\r\n    );\r\n    this.vmlStream.write(\r\n      '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' +\r\n        '<xml xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:x=\"urn:schemas-microsoft-com:office:excel\">' +\r\n        '<o:shapelayout v:ext=\"edit\">' +\r\n        '<o:idmap v:ext=\"edit\" data=\"1\" />' +\r\n        '</o:shapelayout>' +\r\n        '<v:shapetype id=\"_x0000_t202\" coordsize=\"21600,21600\" o:spt=\"202\" path=\"m,l,21600r21600,l21600,xe\">' +\r\n        '<v:stroke joinstyle=\"miter\" />' +\r\n        '<v:path gradientshapeok=\"t\" o:connecttype=\"rect\" />' +\r\n        '</v:shapetype>'\r\n    );\r\n  }\r\n\r\n  _writeComment(comment, index) {\r\n    const commentXform = new CommentXform();\r\n    const commentsXmlStream = new XmlStream();\r\n    commentXform.render(commentsXmlStream, comment);\r\n    this.commentsStream.write(commentsXmlStream.xml);\r\n\r\n    const vmlShapeXform = new VmlShapeXform();\r\n    const vmlXmlStream = new XmlStream();\r\n    vmlShapeXform.render(vmlXmlStream, comment, index);\r\n    this.vmlStream.write(vmlXmlStream.xml);\r\n  }\r\n\r\n  _writeClose() {\r\n    this.commentsStream.write('</commentList></comments>');\r\n    this.vmlStream.write('</xml>');\r\n  }\r\n\r\n  addComments(comments) {\r\n    if (comments && comments.length) {\r\n      if (!this.startedData) {\r\n        this._worksheet.comments = [];\r\n        this._writeOpen();\r\n        this._addRelationships();\r\n        this._addCommentRefs();\r\n        this.startedData = true;\r\n      }\r\n\r\n      comments.forEach(item => {\r\n        item.refAddress = colCache.decodeAddress(item.ref);\r\n      });\r\n\r\n      comments.forEach(comment => {\r\n        this._writeComment(comment, this.count);\r\n        this.count += 1;\r\n      });\r\n    }\r\n  }\r\n\r\n  commit() {\r\n    if (this.count) {\r\n      this._writeClose();\r\n      this.commentsStream.end();\r\n      this.vmlStream.end();\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = SheetCommentsWriter;\r\n"],"mappings":"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"}